<?php
// –í–∫–ª—é—á–∏–º –≤—Å–µ –æ—à–∏–±–∫–∏
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

require 'vendor/autoload.php';

use App\ElasticNews;

echo "<h1>üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π Elasticsearch</h1>";
echo "<p>–≠—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É Elasticsearch –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</p>";

$news = new ElasticNews();

// 1. –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å (–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —Ç–µ—Å—Ç–∞)
echo "<h2>1. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞</h2>";
echo "<pre>" . $news->createIndex() . "</pre>";

// 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
echo "<h2>2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π</h2>";

$testNews = [
    1 => [
        'title' => '–¢–µ—Å—Ç –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π',
        'content' => '–ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –æ—Ç—Ä–∞—Å–ª–∏ –†–æ—Å—Å–∏–∏ –∏ –º–∏—Ä–∞...',
        'category' => '–Ω–∞—É–∫–∞',
        'author' => '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        'published_date' => '2024-01-15',
        'tags' => ['–∫–æ—Å–º–æ—Å', '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '–†–æ—Å—Å–∏—è'],
        'views' => 150
    ],
    2 => [
        'title' => '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –≤ –º–µ–¥–∏—Ü–∏–Ω–µ',
        'content' => '–ò–ò –ø–æ–º–æ–≥–∞–µ—Ç –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ª–µ–∫–∞—Ä—Å—Ç–≤...',
        'category' => '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 
        'author' => '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
        'published_date' => '2024-01-14',
        'tags' => ['–ò–ò', '–º–µ–¥–∏—Ü–∏–Ω–∞', '–∑–¥–æ—Ä–æ–≤—å–µ'],
        'views' => 250
    ],
    3 => [
        'title' => '–≠–∫–æ–ª–æ–≥–∏—è –∏ –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è',
        'content' => '–£—á—ë–Ω—ã–µ –æ–±—Å—É–∂–¥–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è –∏ –ø—É—Ç–∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è...',
        'category' => '—ç–∫–æ–ª–æ–≥–∏—è',
        'author' => '–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤',
        'published_date' => '2024-01-13',
        'tags' => ['—ç–∫–æ–ª–æ–≥–∏—è', '–∫–ª–∏–º–∞—Ç', '–ø—Ä–∏—Ä–æ–¥–∞'],
        'views' => 180
    ]
];

foreach ($testNews as $id => $item) {
    echo "<pre>" . $news->addNews($id, $item) . "</pre>";
}

// 3. –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
echo "<h2>3. –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏...</h2>";
sleep(2);
echo "<pre>‚úÖ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</pre>";

// 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
echo "<h2>4. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ —Å–ª–æ–≤—É '–∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö'</h2>";
echo "<pre>" . $news->searchNews('–∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö') . "</pre>";

echo "<h2>5. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ —Å–ª–æ–≤—É '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'</h2>";
echo "<pre>" . $news->searchNews('—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏') . "</pre>";

echo "<h2>6. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'</h2>";
echo "<pre>" . $news->searchByCategory('—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏') . "</pre>";

echo "<h2>7. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '–Ω–∞—É–∫–∞'</h2>";
echo "<pre>" . $news->searchByCategory('–Ω–∞—É–∫–∞') . "</pre>";

echo "<h2>8. –í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏</h2>";
echo "<pre>" . $news->getAllNews() . "</pre>";

echo "<h2>9. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>";
echo "<pre>" . $news->getStats() . "</pre>";

// 10. –ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Elasticsearch
echo "<h2>10. –ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Elasticsearch</h2>";
try {
    $client = new GuzzleHttp\Client(['base_uri' => 'http://elasticsearch:9200/']);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    $response = $client->get("news/_count");
    $data = json_decode($response->getBody(), true);
    echo "<pre>üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å–µ: " . $data['count'] . "</pre>";
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –∏–Ω–¥–µ–∫—Å–∞
    $response = $client->get("_cluster/health");
    $health = json_decode($response->getBody(), true);
    echo "<pre>üè• –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞: " . $health['status'] . "</pre>";
    
} catch (Exception $e) {
    echo "<pre>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Elasticsearch: " . $e->getMessage() . "</pre>";
}

// 11. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–Ω–¥–µ–∫—Å–∞
echo "<h2>11. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–¥–µ–∫—Å–∞</h2>";
try {
    $client = new GuzzleHttp\Client(['base_uri' => 'http://elasticsearch:9200/']);
    $response = $client->get("news/_mapping");
    $mapping = json_decode($response->getBody(), true);
    echo "<pre>" . json_encode($mapping, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "</pre>";
} catch (Exception $e) {
    echo "<pre>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: " . $e->getMessage() . "</pre>";
}

echo "<hr>";
echo "<h2>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>";
echo "<p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö 4-8, –∑–Ω–∞—á–∏—Ç Elasticsearch —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p>";
echo "<p><a href='index.php'>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é</a></p>";
?>